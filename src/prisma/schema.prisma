// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")
  directUrl    = env("DIRECT_URL")
  relationMode = "prisma"
}

// MODELS

model User {
  id                      String                  @id @default(cuid())
  name                    String
  email                   String                  @unique
  password                String
  avatar                  String?
  role                    UserRole                @default(STUDENT)
  isActive                Boolean                 @default(true)
  isTwoFactorEnabled      Boolean                 @default(false)
  twoFactorSecret         String?
  registeredDate          DateTime                @default(now())
  updatedAt               DateTime                @updatedAt
  theme                   String?                 @default("light")
  xp                      Int?                    @default(0)
  showInLeaderboard       Boolean?                @default(true)
  customPermissions       String[]
  processId               String?
  process                 Process?                @relation(fields: [processId], references: [id], onDelete: SetNull)
  courses                 Course[]                @relation("InstructorCourses")
  enrollments             Enrollment[]
  progress                CourseProgress[]
  announcements           Announcement[]
  announcementReads       AnnouncementRead[]
  announcementReactions   AnnouncementReaction[]
  notes                   UserNote[]
  formResponses           FormResponse[]
  authoredTemplates       LessonTemplate[]
  createdResources        EnterpriseResource[]    @relation("Uploader")
  sharedResources         EnterpriseResource[]    @relation("SharedWith")
  collaboratingResources  EnterpriseResource[]    @relation("Collaborators")
  createdVersions         ResourceVersion[]
  createdMotivationalMessages MotivationalMessage[]
  notifications           Notification[]
  quizAttempts            QuizAttempt[]
  courseComments          CourseComment[]
  eventCreations          CalendarEvent[]
  eventAttendances        CalendarEvent[]         @relation("EventAttendees")
  eventParticipations     EventParticipation[]
  courseAssignments       CourseAssignment[]
  assignedCourses         CourseAssignment[]      @relation("AssignedBy")
  messages                Message[]
  conversations           Conversation[]          @relation("ConversationParticipants")
}

model Course {
  id                      String                  @id @default(cuid())
  title                   String
  description             String?
  category                String?
  status                  CourseStatus            @default(DRAFT)
  imageUrl                String?
  instructorId            String
  instructor              User                    @relation("InstructorCourses", fields: [instructorId], references: [id], onDelete: Cascade)
  modules                 Module[]
  enrollments             Enrollment[]
  progress                CourseProgress[]
  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt
  publicationDate         DateTime?
  startDate               DateTime?
  endDate                 DateTime?
  isMandatory             Boolean                 @default(false)
  prerequisiteId          String?                 @unique
  prerequisite            Course?                 @relation("CoursePrerequisites", fields: [prerequisiteId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  prerequisiteFor         Course?                 @relation("CoursePrerequisites")
  certificateTemplateId   String?
  certificateTemplate     CertificateTemplate?    @relation(fields: [certificateTemplateId], references: [id], onDelete: SetNull)
  comments                CourseComment[]
  assignments             CourseAssignment[]
}

model Module {
  id                      String                  @id @default(cuid())
  title                   String
  order                   Int
  courseId                String
  course                  Course                  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons                 Lesson[]
}

model Lesson {
  id                      String                  @id @default(cuid())
  title                   String
  order                   Int
  moduleId                String
  module                  Module                  @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  contentBlocks           ContentBlock[]
  notes                   UserNote[]
  completedBy             LessonCompletionRecord[]
}

model ContentBlock {
  id                      String                  @id @default(cuid())
  type                    LessonType
  content                 String?
  order                   Int
  lessonId                String
  lesson                  Lesson                  @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  quiz                    Quiz?
}

model Enrollment {
  id                      String                  @id @default(cuid())
  userId                  String
  courseId                String
  enrolledAt              DateTime                @default(now())
  user                    User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  course                  Course                  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  progress                CourseProgress?

  @@unique([userId, courseId])
}

model CourseProgress {
  id                      String                  @id @default(cuid())
  userId                  String
  courseId                String
  progressPercentage      Int?                    @default(0)
  completedAt             DateTime?
  lastActivity            DateTime                @default(now()) @updatedAt
  user                    User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  course                  Course                  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  completedLessons        LessonCompletionRecord[]
  enrollment              Enrollment              @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  enrollmentId            String                  @unique

  @@unique([userId, courseId])
}

model LessonCompletionRecord {
  id                      String                  @id @default(cuid())
  progressId              String
  progress                CourseProgress          @relation(fields: [progressId], references: [id], onDelete: Cascade)
  lessonId                String
  lesson                  Lesson                  @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  completedAt             DateTime                @default(now())
  type                    LessonInteractionType   @default(VIEW)
  score                   Float?

  @@unique([progressId, lessonId])
}

model UserNote {
  id                      String                  @id @default(cuid())
  userId                  String
  user                    User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  lessonId                String
  lesson                  Lesson                  @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  content                 String
  color                   String                  @default("yellow")
  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt

  @@unique([userId, lessonId])
}

model EnterpriseResource {
  id                      String                  @id @default(cuid())
  title                   String
  type                    ResourceType
  url                     String?
  description             String?
  content                 String?
  observations            String?
  category                String?
  tags                    String?
  version                 Int                     @default(1)
  isPinned                Boolean                 @default(false)
  sharingMode             ResourceSharingMode     @default(PUBLIC)
  pin                     String?
  uploaderId              String
  uploader                User                    @relation("Uploader", fields: [uploaderId], references: [id], onDelete: Cascade)
  sharedWith              User[]                  @relation("SharedWith")
  sharedWithProcesses     Process[]               @relation("SharedWithProcesses")
  collaborators           User[]                  @relation("Collaborators")
  uploadDate              DateTime                @default(now())
  updatedAt               DateTime                @updatedAt
  status                  ResourceStatus          @default(ACTIVE)
  expiresAt               DateTime?
  size                    Int?
  filetype                String?
  parentId                String?
  parent                  EnterpriseResource?     @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children                EnterpriseResource[]    @relation("FolderHierarchy")
  versions                ResourceVersion[]
  quiz                    Quiz?
  order                   Int?
}

model Announcement {
  id                      String                  @id @default(cuid())
  title                   String
  content                 String
  date                    DateTime                @default(now())
  authorId                String
  author                  User                    @relation(fields: [authorId], references: [id], onDelete: Cascade)
  audience                String
  priority                String                  @default("Normal")
  isPinned                Boolean                 @default(false)
  attachments             AnnouncementAttachment[]
  reads                   AnnouncementRead[]
  reactions               AnnouncementReaction[]
  notifications           Notification[]
}

model Notification {
  id                      String          @id @default(cuid())
  userId                  String
  user                    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  title                   String
  description             String?
  link                    String?
  read                    Boolean         @default(false)
  createdAt               DateTime        @default(now())
  isMotivational          Boolean         @default(false)
  motivationalMessageId   String?
  motivationalMessage     MotivationalMessage? @relation(fields: [motivationalMessageId], references: [id], onDelete: SetNull)
  announcementId          String?
  announcement            Announcement?   @relation(fields: [announcementId], references: [id], onDelete: SetNull)
  interactiveEventId      String?
  interactiveEvent        CalendarEvent?  @relation(fields: [interactiveEventId], references: [id], onDelete: SetNull)
  interactiveEventOccurrence DateTime?

  @@index([userId])
}

model CalendarEvent {
  id                      String                @id @default(cuid())
  title                   String
  description             String?
  location                String?
  videoConferenceLink     String?
  start                   DateTime
  end                     DateTime
  allDay                  Boolean               @default(false)
  audienceType            EventAudienceType     @default(ALL)
  attendees               User[]                @relation("EventAttendees")
  color                   String?
  creatorId               String
  creator                 User                  @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  attachments             Json?
  recurrence              RecurrenceType        @default(NONE)
  recurrenceEndDate       DateTime?
  isInteractive           Boolean               @default(false)
  imageUrl                String?
  participations          EventParticipation[]
  interactiveNotifications Notification[]
}

model Form {
  id                  String            @id @default(cuid())
  title               String
  description         String?
  status              FormStatus        @default(DRAFT)
  isQuiz              Boolean           @default(false)
  creatorId           String
  creator             User              @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  fields              FormField[]
  responses           FormResponse[]
  sharedWith          User[]
  headerImageUrl      String?
  themeColor          String?           @default("#6366f1")
  backgroundColor     String?           @default("#f8fafc")
  fontStyle           String?           @default("default")
  gameSessions        GameSession[]
}

model FormField {
  id                  String            @id @default(cuid())
  formId              String
  form                Form              @relation(fields: [formId], references: [id], onDelete: Cascade)
  order               Int
  label               String
  type                FormFieldType
  placeholder         String?
  required            Boolean           @default(false)
  options             Json?             // Para 'SINGLE_CHOICE' o 'MULTIPLE_CHOICE'
  responses           FormResponseAnswer[]
  template            String?           @default("default")
  imageUrl            String?
}

model FormFieldOption {
  id                  String              @id @default(cuid())
  fieldId             String
  field               FormField           @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  text                String
  isCorrect           Boolean             @default(false)
  points              Int                 @default(0)
  imageUrl            String?
  answerAttempts      AnswerAttempt[]
}

model FormResponse {
  id                  String            @id @default(cuid())
  formId              String
  form                Form              @relation(fields: [formId], references: [id], onDelete: Cascade)
  userId              String
  user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  submittedAt         DateTime          @default(now())
  answers             FormResponseAnswer[]
  score               Float? // Porcentaje
}

model FormResponseAnswer {
  id                  String            @id @default(cuid())
  responseId          String
  response            FormResponse      @relation(fields: [responseId], references: [id], onDelete: Cascade)
  fieldId             String
  field               FormField         @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  value               String // JSON para respuestas m√∫ltiples
}

model SecurityLog {
  id                  String            @id @default(cuid())
  event               SecurityLogEvent
  userId              String?
  user                User?             @relation(fields: [userId], references: [id], onDelete: SetNull)
  ipAddress           String?
  userAgent           String?
  country             String?
  city                String?
  emailAttempt        String?
  details             String?
  createdAt           DateTime          @default(now())
}

model PlatformSettings {
  id                          String      @id @default("cl-nexus-settings-default")
  platformName                String      @default("NexusAlpri")
  projectVersion              String?     @default("1.0.0")
  allowPublicRegistration     Boolean     @default(true)
  enableEmailNotifications    Boolean     @default(true)
  emailWhitelist              String?     @default("alprigrama.com")
  passwordMinLength           Int         @default(8)
  passwordRequireUppercase    Boolean     @default(true)
  passwordRequireLowercase    Boolean     @default(true)
  passwordRequireNumber       Boolean     @default(true)
  passwordRequireSpecialChar  Boolean     @default(false)
  enableIdleTimeout           Boolean     @default(true)
  idleTimeoutMinutes          Int         @default(20)
  require2faForAdmins         Boolean     @default(false)
  resourceCategories          String?     @default("General,Recursos Humanos,Ventas")
  primaryColor                String?
  secondaryColor              String?
  accentColor                 String?
  backgroundColorLight        String?
  primaryColorDark            String?
  backgroundColorDark         String?
  fontHeadline                String?
  fontBody                    String?
  logoUrl                     String?
  faviconUrl                  String?
  watermarkUrl                String?
  landingImageUrl             String?
  authImageUrl                String?
  aboutImageUrl               String?
  benefitsImageUrl            String?
  announcementsImageUrl       String?
  publicPagesBgUrl            String?
  securityAuditImageUrl       String?
  tourMascotUrl               String?
  dashboardImageUrlAdmin      String?
  dashboardImageUrlInstructor String?
  dashboardImageUrlStudent    String?
  emptyStateCoursesUrl        String?
  emptyStateMyCoursesUrl      String?
  emptyStateFormsUrl          String?
  emptyStateMyNotesUrl        String?
  emptyStateResourcesUrl      String?
  emptyStateCertificatesUrl   String?
  emptyStateMotivationsUrl    String?
  emptyStateUsersUrl          String?
  emptyStateLeaderboardUrl    String?
  emptyStateAnnouncementsUrl  String?
  roadmapPhases               RoadmapPhase[]
  roadmapVisibleTo            UserRole[]
  roadmapImageUrl             String?
  createdAt                   DateTime    @default(now())
  updatedAt                   DateTime    @updatedAt
}

model Achievement {
  id                  String             @id @default(cuid())
  slug                AchievementSlug    @unique
  name                String
  description         String
  icon                String?
  points              Int
  users               UserAchievement[]
}

model UserAchievement {
  id                  String             @id @default(cuid())
  userId              String
  user                User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievementId       String
  achievement         Achievement        @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  unlockedAt          DateTime           @default(now())

  @@unique([userId, achievementId])
}

model MotivationalMessage {
  id                  String                       @id @default(cuid())
  title               String
  content             String?
  imageUrl            String?
  videoUrl            String?
  triggerType         MotivationalMessageTriggerType
  triggerId           String
  creatorId           String
  creator             User                         @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  createdAt           DateTime                     @default(now())
  notifications       Notification[]
  
  @@unique([triggerType, triggerId])
}

model CertificateTemplate {
  id                    String        @id @default(cuid())
  name                  String        @unique
  backgroundImageUrl    String
  textColor             String?
  studentNamePosition   Json?
  courseNamePosition    Json?
  datePosition          Json?
  scorePosition         Json?
  logoUrl               String?
  logoPosition          Json?
  watermarkUrl          String?
  watermarkOpacity      Float?        @default(0.1)
  footerText            String?
  footerTextPosition    Json?
  fontFamilyHeadline    String?
  fontFamilyBody        String?
  courses               Course[]
  createdAt             DateTime      @default(now())
}

model Process {
  id                  String    @id @default(cuid())
  name                String    @unique
  parentId            String?
  parent              Process?  @relation("ProcessHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children            Process[] @relation("ProcessHierarchy")
  users               User[]
  sharedResources     EnterpriseResource[] @relation("SharedWithProcesses")
}

// ENUMS
enum UserRole {
  STUDENT
  INSTRUCTOR
  ADMINISTRATOR
}

enum CourseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum LessonType {
  TEXT
  VIDEO
  QUIZ
  FILE
}

enum ResourceType {
  FOLDER
  DOCUMENT
  GUIDE
  MANUAL
  POLICY
  VIDEO
  EXTERNAL_LINK
  OTHER
  DOCUMENTO_EDITABLE
  VIDEO_PLAYLIST
}

enum ResourceStatus {
  ACTIVE
  ARCHIVED
}

enum FormStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum FormFieldType {
  SHORT_TEXT
  LONG_TEXT
  SINGLE_CHOICE
  MULTIPLE_CHOICE
}

enum SecurityLogEvent {
  SUCCESSFUL_LOGIN
  FAILED_LOGIN_ATTEMPT
  PASSWORD_CHANGE_SUCCESS
  TWO_FACTOR_ENABLED
  TWO_FACTOR_DISABLED
  USER_ROLE_CHANGED
  COURSE_CREATED
  COURSE_UPDATED
  COURSE_DELETED
  USER_SUSPENDED
}

enum AchievementSlug {
  FIRST_ENROLLMENT
  FIRST_COURSE_COMPLETED
  PERFECT_QUIZ_SCORE
  FIVE_COURSES_COMPLETED
  FIRST_NOTE
  FIRST_REACTION
  FIRST_RESOURCE_DOWNLOAD
  FIRST_COURSE_PUBLISHED
  TEN_COURSES_COMPLETED
  TWENTY_COURSES_COMPLETED
  HIGH_PERFORMER
  LEVEL_5_REACHED
  LEVEL_10_REACHED
  LEVEL_20_REACHED
}

enum EventAudienceType {
  ALL
  ADMINISTRATOR
  INSTRUCTOR
  STUDENT
  SPECIFIC
}

enum RecurrenceType {
  NONE
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

enum LessonInteractionType {
  VIEW
  QUIZ
  VIDEO
}

enum MotivationalMessageTriggerType {
  COURSE_ENROLLMENT
  COURSE_MID_PROGRESS
  COURSE_NEAR_COMPLETION
  COURSE_COMPLETION
  LEVEL_UP
}

enum ResourceSharingMode {
  PUBLIC
  PRIVATE
  PROCESS
}
